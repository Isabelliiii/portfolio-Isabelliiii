{
  "hash": "156475d073224ea469690bec835c92e5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Space-Time Prediction of Bike Share Demand: Philadelphia Indego\"\nsubtitle: \"MUSA 5080 - Fall 2025\"\nauthor: \"Isabelle Li\"\ndate: today\nformat:\n  html:\n    code-fold: show\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n# Part 1: Data Import & Preparation\n\n## 1.1 Set up\n\n### Load package\n\n\n::: {.cell}\n\n:::\n\n\n### Define theme\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotTheme <- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  plot.subtitle = element_text(size = 10),\n  plot.caption = element_text(size = 8),\n  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),\n  axis.text.y = element_text(size = 10),\n  axis.title = element_text(size = 11, face = \"bold\"),\n  panel.background = element_blank(),\n  panel.grid.major = element_line(colour = \"#D0D0D0\", size = 0.2),\n  panel.grid.minor = element_blank(),\n  axis.ticks = element_blank(),\n  legend.position = \"right\"\n)\n\nmapTheme <- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  plot.subtitle = element_text(size = 10),\n  plot.caption = element_text(size = 8),\n  axis.line = element_blank(),\n  axis.text = element_blank(),\n  axis.ticks = element_blank(),\n  axis.title = element_blank(),\n  panel.background = element_blank(),\n  panel.border = element_blank(),\n  panel.grid.major = element_line(colour = 'transparent'),\n  panel.grid.minor = element_blank(),\n  legend.position = \"right\",\n  plot.margin = margin(1, 1, 1, 1, 'cm'),\n  legend.key.height = unit(1, \"cm\"),\n  legend.key.width = unit(0.2, \"cm\")\n)\n\npalette5 <- c(\"#eff3ff\", \"#bdd7e7\", \"#6baed6\", \"#3182bd\", \"#08519c\")\n```\n:::\n\n\n### Set Census API Key\n\n\n\n\n\n## 1.2 Data Import\n\n\n\n\n\n### Create Time Bins\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindego <- indego %>%\n  mutate(\n    # Parse datetime\n    start_datetime = mdy_hm(start_time),\n    end_datetime = mdy_hm(end_time),\n    \n    # Create hourly bins\n    interval60 = floor_date(start_datetime, unit = \"hour\"),\n    \n    # Extract time features\n    week = week(interval60),\n    month = month(interval60, label = TRUE),\n    dotw = wday(interval60, label = TRUE),\n    hour = hour(interval60),\n    date = as.Date(interval60),\n    \n    # Create useful indicators\n    weekend = ifelse(dotw %in% c(\"Sat\", \"Sun\"), 1, 0),\n    rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)\n  )\n```\n:::\n\n\n## 1.3 Exploratory Analysis\n\n### Trips over time\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](assignment5-Isabelle-Li_files/figure-html/trips_over_time-1.png){width=672}\n:::\n:::\n\n\nThe Q2 2025 ridership pattern reflects typical late-spring to early-summer behavior. Overalll daily trip volumes are high compared to winter months, with most days falling between 3,500 and 5,000 trips.\n\n### Hourly Patterns\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](assignment5-Isabelle-Li_files/figure-html/hourly_patterns-1.png){width=672}\n:::\n:::\n\n\nThe hourly ridership profile shows a strong distinction between weekdays and weekends. On weekdays, the pattern is dominated by two sharp peaks: a large morning spike around 8–9 AM and an even stronger afternoon peak around 5–6 PM. These align closely with traditional commuting hours, indicating that Indego is heavily used for work-related travel during the week.\n\nIn contrast, weekend ridership follows a flatter, more gradual curve. Activity starts later in the morning, rises steadily through midday, and maintains moderate levels into the afternoon without a pronounced rush-hour peak. This reflects more recreational and discretionary trips rather than structured commuting patterns.\n\n### Top Station\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Most popular origin stations\ntop_stations <- indego %>%\n  count(start_station, start_lat, start_lon, name = \"trips\") %>%\n  arrange(desc(trips)) %>%\n  head(20)\n\nkable(top_stations, \n      caption = \"Top 20 Indego Stations by Trip Origins\",\n      format.args = list(big.mark = \",\")) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Top 20 Indego Stations by Trip Origins</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> start_station </th>\n   <th style=\"text-align:right;\"> start_lat </th>\n   <th style=\"text-align:right;\"> start_lon </th>\n   <th style=\"text-align:right;\"> trips </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 3,010 </td>\n   <td style=\"text-align:right;\"> 39.94711 </td>\n   <td style=\"text-align:right;\"> -75.16618 </td>\n   <td style=\"text-align:right;\"> 6,278 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,032 </td>\n   <td style=\"text-align:right;\"> 39.94527 </td>\n   <td style=\"text-align:right;\"> -75.17971 </td>\n   <td style=\"text-align:right;\"> 4,751 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,359 </td>\n   <td style=\"text-align:right;\"> 39.94888 </td>\n   <td style=\"text-align:right;\"> -75.16978 </td>\n   <td style=\"text-align:right;\"> 4,181 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,028 </td>\n   <td style=\"text-align:right;\"> 39.94061 </td>\n   <td style=\"text-align:right;\"> -75.14958 </td>\n   <td style=\"text-align:right;\"> 4,028 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,163 </td>\n   <td style=\"text-align:right;\"> 39.94974 </td>\n   <td style=\"text-align:right;\"> -75.18097 </td>\n   <td style=\"text-align:right;\"> 4,000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,020 </td>\n   <td style=\"text-align:right;\"> 39.94855 </td>\n   <td style=\"text-align:right;\"> -75.19007 </td>\n   <td style=\"text-align:right;\"> 3,946 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,185 </td>\n   <td style=\"text-align:right;\"> 39.95169 </td>\n   <td style=\"text-align:right;\"> -75.15888 </td>\n   <td style=\"text-align:right;\"> 3,914 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,066 </td>\n   <td style=\"text-align:right;\"> 39.94561 </td>\n   <td style=\"text-align:right;\"> -75.17348 </td>\n   <td style=\"text-align:right;\"> 3,899 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,022 </td>\n   <td style=\"text-align:right;\"> 39.95472 </td>\n   <td style=\"text-align:right;\"> -75.18323 </td>\n   <td style=\"text-align:right;\"> 3,856 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,054 </td>\n   <td style=\"text-align:right;\"> 39.96250 </td>\n   <td style=\"text-align:right;\"> -75.17420 </td>\n   <td style=\"text-align:right;\"> 3,767 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,161 </td>\n   <td style=\"text-align:right;\"> 39.95486 </td>\n   <td style=\"text-align:right;\"> -75.18091 </td>\n   <td style=\"text-align:right;\"> 3,629 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,362 </td>\n   <td style=\"text-align:right;\"> 39.94816 </td>\n   <td style=\"text-align:right;\"> -75.16226 </td>\n   <td style=\"text-align:right;\"> 3,552 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,063 </td>\n   <td style=\"text-align:right;\"> 39.94633 </td>\n   <td style=\"text-align:right;\"> -75.16980 </td>\n   <td style=\"text-align:right;\"> 3,516 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,213 </td>\n   <td style=\"text-align:right;\"> 39.93887 </td>\n   <td style=\"text-align:right;\"> -75.16663 </td>\n   <td style=\"text-align:right;\"> 3,332 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,059 </td>\n   <td style=\"text-align:right;\"> 39.96244 </td>\n   <td style=\"text-align:right;\"> -75.16121 </td>\n   <td style=\"text-align:right;\"> 3,320 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,012 </td>\n   <td style=\"text-align:right;\"> 39.94218 </td>\n   <td style=\"text-align:right;\"> -75.17747 </td>\n   <td style=\"text-align:right;\"> 3,264 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,007 </td>\n   <td style=\"text-align:right;\"> 39.94517 </td>\n   <td style=\"text-align:right;\"> -75.15993 </td>\n   <td style=\"text-align:right;\"> 3,242 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,061 </td>\n   <td style=\"text-align:right;\"> 39.95425 </td>\n   <td style=\"text-align:right;\"> -75.17761 </td>\n   <td style=\"text-align:right;\"> 3,193 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,101 </td>\n   <td style=\"text-align:right;\"> 39.94295 </td>\n   <td style=\"text-align:right;\"> -75.15955 </td>\n   <td style=\"text-align:right;\"> 3,170 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3,296 </td>\n   <td style=\"text-align:right;\"> 39.95134 </td>\n   <td style=\"text-align:right;\"> -75.16758 </td>\n   <td style=\"text-align:right;\"> 3,088 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Get Philadelphia Spatial Context\n\n\n\n### Join Census Data to Stations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create sf object for stations\nstations_sf <- indego %>%\n  distinct(start_station, start_lat, start_lon) %>%\n  filter(!is.na(start_lat), !is.na(start_lon)) %>%\n  st_as_sf(coords = c(\"start_lon\", \"start_lat\"), crs = 4326)\n\n# Spatial join to get census tract for each station\nstations_census <- st_join(stations_sf, philly_census, left = TRUE) %>%\n  st_drop_geometry()\n\n# Add census variables back to the trip data\nindego_census <- indego %>%\n  left_join(\n    stations_census %>% \n      select(start_station, Med_Inc, Percent_Taking_Transit, \n             Percent_White, Total_Pop),\n    by = \"start_station\"\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Identify which stations to keep\nvalid_stations <- stations_census %>%\n  filter(!is.na(Med_Inc)) %>%\n  pull(start_station)\n\n# Filter trip data to valid stations only\nindego_census <- indego %>%\n  filter(start_station %in% valid_stations) %>%\n  left_join(\n    stations_census %>% \n      select(start_station, Med_Inc, Percent_Taking_Transit, \n             Percent_White, Total_Pop),\n    by = \"start_station\"\n  )\n```\n:::\n\n\n### Get Weather Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get weather from Philadelphia International Airport (KPHL)\nweather_data <- riem_measures(\n  station = \"PHL\",  # Philadelphia International Airport\n  date_start = \"2025-04-01\",\n  date_end = \"2025-07-31\"\n)\n\n# Process weather data\nweather_processed <- weather_data %>%\n  mutate(\n    interval60 = floor_date(valid, unit = \"hour\"),\n    Temperature = tmpf,  # Temperature in Fahrenheit\n    Precipitation = ifelse(is.na(p01i), 0, p01i),  # Hourly precip in inches\n    Wind_Speed = sknt  # Wind speed in knots\n  ) %>%\n  select(interval60, Temperature, Precipitation, Wind_Speed) %>%\n  distinct()\n\n# Check for missing hours and interpolate if needed\nweather_complete <- weather_processed %>%\n  complete(interval60 = seq(min(interval60), max(interval60), by = \"hour\")) %>%\n  fill(Temperature, Precipitation, Wind_Speed, .direction = \"down\")\n```\n:::\n\n\n### Create Space-Time Panel\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Count trips by station-hour\ntrips_panel <- indego_census %>%\n  group_by(interval60, start_station, start_lat, start_lon,\n           Med_Inc, Percent_Taking_Transit, Percent_White, Total_Pop) %>%\n  summarize(Trip_Count = n()) %>%\n  ungroup()\n\n# How many station-hour observations?\nnrow(trips_panel)\n\n# How many unique stations?\nlength(unique(trips_panel$start_station))\n\n# How many unique hours?\nlength(unique(trips_panel$interval60))\n```\n:::\n\n\n### Create Complete Panel Structure\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate expected panel size\nn_stations <- length(unique(trips_panel$start_station))\nn_hours <- length(unique(trips_panel$interval60))\nexpected_rows <- n_stations * n_hours\n\ncat(\"Expected panel rows:\", format(expected_rows, big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nExpected panel rows: 548,604 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Current rows:\", format(nrow(trips_panel), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCurrent rows: 179,107 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Missing rows:\", format(expected_rows - nrow(trips_panel), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMissing rows: 369,497 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Create complete panel\nstudy_panel <- expand.grid(\n  interval60 = unique(trips_panel$interval60),\n  start_station = unique(trips_panel$start_station)\n) %>%\n  # Join trip counts\n  left_join(trips_panel, by = c(\"interval60\", \"start_station\")) %>%\n  # Replace NA trip counts with 0\n  mutate(Trip_Count = replace_na(Trip_Count, 0))\n\n# Fill in station attributes (they're the same for all hours)\nstation_attributes <- trips_panel %>%\n  group_by(start_station) %>%\n  summarize(\n    start_lat = first(start_lat),\n    start_lon = first(start_lon),\n    Med_Inc = first(Med_Inc),\n    Percent_Taking_Transit = first(Percent_Taking_Transit),\n    Percent_White = first(Percent_White),\n    Total_Pop = first(Total_Pop)\n  )\n\nstudy_panel <- study_panel %>%\n  left_join(station_attributes, by = \"start_station\")\n\n# Verify we have complete panel\ncat(\"Complete panel rows:\", format(nrow(study_panel), big.mark = \",\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nComplete panel rows: 548,604 \n```\n\n\n:::\n:::\n\n\n### Add Time Features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstudy_panel <- study_panel %>%\n  mutate(\n    week = week(interval60),\n    month = lubridate::month(interval60, label = TRUE, abbr = TRUE),\n    month = factor(month, levels = month.abb),  # Jan, Feb, ..., Dec\n    dotw = wday(interval60, label = TRUE),\n    hour = hour(interval60),\n    date = as.Date(interval60),\n    weekend = ifelse(dotw %in% c(\"Sat\", \"Sun\"), 1, 0),\n    rush_hour = ifelse(hour %in% c(7, 8, 9, 16, 17, 18), 1, 0)\n  )\n```\n:::\n\n\n### Join Weather Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstudy_panel <- study_panel %>%\n  left_join(weather_complete, by = \"interval60\")\n```\n:::\n\n\n### Create Temporal Lag Variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sort by station and time\nstudy_panel <- study_panel %>%\n  arrange(start_station, interval60)\n\n# Create lag variables WITHIN each station\nstudy_panel <- study_panel %>%\n  group_by(start_station) %>%\n  mutate(\n    lag1Hour = lag(Trip_Count, 1),\n    lag2Hours = lag(Trip_Count, 2),\n    lag3Hours = lag(Trip_Count, 3),\n    lag12Hours = lag(Trip_Count, 12),\n    lag1day = lag(Trip_Count, 24)\n  ) %>%\n  ungroup()\n\n# Remove rows with NA lags (first 24 hours for each station)\nstudy_panel_complete <- study_panel %>%\n  filter(!is.na(lag1day))\n```\n:::\n\n\n\n\n### Temporal Train/Test Split\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Identify early and late period for Q2\n# Q2 roughly covers week 14–26\n\nearly_stations <- study_panel_complete %>%\n  filter(week >= 13, week < 22) %>%    # weeks 13–21\n  filter(Trip_Count > 0) %>%\n  distinct(start_station) %>%\n  pull(start_station)\n\nlate_stations <- study_panel_complete %>%\n  filter(week >= 22, week <= 26) %>%   # weeks 22–26\n  filter(Trip_Count > 0) %>%\n  distinct(start_station) %>%\n  pull(start_station)\n\n# Keep only stations appearing in both early and late\ncommon_stations <- intersect(early_stations, late_stations)\n\nstudy_panel_complete <- study_panel_complete %>%\n  filter(start_station %in% common_stations)\n\n# Now create train/test split\ntrain <- study_panel_complete %>%\n  filter(week >= 13, week < 22)\n\ntest <- study_panel_complete %>%\n  filter(week >= 22, week <= 26)\n```\n:::\n\n\n## 1.4 Build Predictive Models\n\n### Model 1: Baseline (Time + Weather)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create day of week factor with treatment (dummy) coding\ntrain <- train %>%\n  mutate(dotw_simple = factor(dotw, levels = c(\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\")))\n\n# Set contrasts to treatment coding (dummy variables)\ncontrasts(train$dotw_simple) <- contr.treatment(7)\n\n# Now run the model\nmodel1 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation,\n  data = train\n)\n\nmodel1_tidy <- tidy(model1) %>%\n  filter(term %in% c(\"Temperature\", \"Precipitation\", \n                     \"dotw_simple2\", \"dotw_simple3\", \"dotw_simple4\",\n                     \"dotw_simple5\", \"dotw_simple6\", \"dotw_simple7\")) %>%\n  mutate(\n    estimate = round(estimate, 3),\n    p.value = format.pval(p.value, digits = 3)\n  )\n\nkable(model1_tidy,\n      caption = \"Selected Coefficients from Model 1 (Q2 2025)\",\n      col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"p value\")) %>%\n  kable_classic(full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n<caption>Selected Coefficients from Model 1 (Q2 2025)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Term </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> t value </th>\n   <th style=\"text-align:left;\"> p value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple2 </td>\n   <td style=\"text-align:right;\"> 0.047 </td>\n   <td style=\"text-align:right;\"> 0.0062891 </td>\n   <td style=\"text-align:right;\"> 7.438893 </td>\n   <td style=\"text-align:left;\"> 0.000000000000102 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple3 </td>\n   <td style=\"text-align:right;\"> 0.008 </td>\n   <td style=\"text-align:right;\"> 0.0063365 </td>\n   <td style=\"text-align:right;\"> 1.305814 </td>\n   <td style=\"text-align:left;\"> 0.19162 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple4 </td>\n   <td style=\"text-align:right;\"> 0.042 </td>\n   <td style=\"text-align:right;\"> 0.0062043 </td>\n   <td style=\"text-align:right;\"> 6.761778 </td>\n   <td style=\"text-align:left;\"> 0.000000000013648 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple5 </td>\n   <td style=\"text-align:right;\"> -0.017 </td>\n   <td style=\"text-align:right;\"> 0.0061253 </td>\n   <td style=\"text-align:right;\"> -2.825335 </td>\n   <td style=\"text-align:left;\"> 0.00472 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple6 </td>\n   <td style=\"text-align:right;\"> -0.027 </td>\n   <td style=\"text-align:right;\"> 0.0064698 </td>\n   <td style=\"text-align:right;\"> -4.238667 </td>\n   <td style=\"text-align:left;\"> 0.000022489666761 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dotw_simple7 </td>\n   <td style=\"text-align:right;\"> -0.068 </td>\n   <td style=\"text-align:right;\"> 0.0065597 </td>\n   <td style=\"text-align:right;\"> -10.320271 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0000000000000002 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Temperature </td>\n   <td style=\"text-align:right;\"> 0.013 </td>\n   <td style=\"text-align:right;\"> 0.0001728 </td>\n   <td style=\"text-align:right;\"> 76.011086 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0000000000000002 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Precipitation </td>\n   <td style=\"text-align:right;\"> -0.025 </td>\n   <td style=\"text-align:right;\"> 0.0232841 </td>\n   <td style=\"text-align:right;\"> -1.060071 </td>\n   <td style=\"text-align:left;\"> 0.28911 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nRidership is highly driven by time-of-day: morning and evening commute hours show the largest positive effects, while late night hours have the lowest activity.\\\n\nWeekdays generally have higher demand than weekends, and temperature is strongly positively associated with trip counts. Precipitation shows a small negative effect but is not statistically strong in this period.\n\n### Model 2: Add Temporal Lags\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel2 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day,\n  data = train\n)\n\nmodel2_tidy <- tidy(model2) %>%\n  filter(term %in% c(\"Temperature\", \"Precipitation\",\n                     \"lag1Hour\", \"lag3Hours\", \"lag1day\")) %>%\n  mutate(\n    estimate   = round(estimate, 3),\n    std.error  = round(std.error, 3),\n    statistic  = round(statistic, 1),\n    p.value    = format.pval(p.value, digits = 3, eps = 1e-4)\n  )\n\nkable(\n  model2_tidy,\n  caption = \"Key coefficients from Model 2 (Q2 2025)\",\n  col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"p value\")\n) %>%\n  kable_classic(full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n<caption>Key coefficients from Model 2 (Q2 2025)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Term </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> t value </th>\n   <th style=\"text-align:left;\"> p value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Temperature </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 25.0 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Precipitation </td>\n   <td style=\"text-align:right;\"> -0.070 </td>\n   <td style=\"text-align:right;\"> 0.020 </td>\n   <td style=\"text-align:right;\"> -3.6 </td>\n   <td style=\"text-align:left;\"> 0.000378 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag1Hour </td>\n   <td style=\"text-align:right;\"> 0.415 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 296.4 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag3Hours </td>\n   <td style=\"text-align:right;\"> 0.120 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 86.7 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag1day </td>\n   <td style=\"text-align:right;\"> 0.137 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 107.1 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe coefficients on the lag variables are all positive and highly significant: the previous hour’s demand (lag1Hour, β ≈ 0.42), demand three hours ago (lag3Hours, β ≈ 0.12), and demand 24 hours ago (lag1day, β ≈ 0.14) all strongly predict current ridership. This means that if a station was busy in the recent past, it is very likely to be busy now as well. Compared to Model 1, the effect of temperature becomes smaller because part of the temporal pattern is now captured by lagged demand. Precipitation becomes more negative and statistically significant, indicating that rainy hours reduce trips even after controlling for recent usage. Overall, adding lag features increases R² from about 0.11 to 0.36 and reduces the residual error, showing that short-term temporal dependence is a key driver of Indego ridership.\n\n### Model 3: Add Demographics\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel3 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Med_Inc.x + Percent_Taking_Transit.y + Percent_White.y,\n  data = train\n)\n\nmodel3_tidy <- tidy(model3) %>%\n  filter(term %in% c(\"Temperature\", \"Precipitation\",\n                     \"lag1Hour\", \"lag3Hours\", \"lag1day\",\n                     \"Med_Inc.x\", \"Percent_Taking_Transit.y\", \"Percent_White.y\")) %>%\n  mutate(\n    estimate  = round(estimate, 4),\n    std.error = round(std.error, 4),\n    statistic = round(statistic, 1),\n    p.value   = format.pval(p.value, digits = 3, eps = 1e-4)\n  )\n\nkable(\n  model3_tidy,\n  caption = \"Key Coefficients for Model 3 (Adding Census Features)\",\n  col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"p value\")\n) %>%\n  kable_classic(full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n<caption>Key Coefficients for Model 3 (Adding Census Features)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Term </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> t value </th>\n   <th style=\"text-align:left;\"> p value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Temperature </td>\n   <td style=\"text-align:right;\"> 0.0072 </td>\n   <td style=\"text-align:right;\"> 0.0004 </td>\n   <td style=\"text-align:right;\"> 20.3 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Precipitation </td>\n   <td style=\"text-align:right;\"> -0.3160 </td>\n   <td style=\"text-align:right;\"> 0.0364 </td>\n   <td style=\"text-align:right;\"> -8.7 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag1Hour </td>\n   <td style=\"text-align:right;\"> 0.3077 </td>\n   <td style=\"text-align:right;\"> 0.0023 </td>\n   <td style=\"text-align:right;\"> 133.6 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag3Hours </td>\n   <td style=\"text-align:right;\"> 0.0855 </td>\n   <td style=\"text-align:right;\"> 0.0024 </td>\n   <td style=\"text-align:right;\"> 36.1 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lag1day </td>\n   <td style=\"text-align:right;\"> 0.1191 </td>\n   <td style=\"text-align:right;\"> 0.0022 </td>\n   <td style=\"text-align:right;\"> 53.3 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Med_Inc.x </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n   <td style=\"text-align:right;\"> 2.7 </td>\n   <td style=\"text-align:left;\"> 0.00689 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Percent_Taking_Transit.y </td>\n   <td style=\"text-align:right;\"> -0.0041 </td>\n   <td style=\"text-align:right;\"> 0.0004 </td>\n   <td style=\"text-align:right;\"> -9.7 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Percent_White.y </td>\n   <td style=\"text-align:right;\"> 0.0025 </td>\n   <td style=\"text-align:right;\"> 0.0002 </td>\n   <td style=\"text-align:right;\"> 11.6 </td>\n   <td style=\"text-align:left;\"> &lt; 0.0001 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nThe lag variables (lag1Hour, lag3Hours, lag1day) remain the strongest predictors, confirming that short-term demand history is still the main driver of current ridership. Among the census features, higher median income around a station is associated with slightly higher usage, while neighborhoods with higher transit dependence tend to show lower Indego demand. The percentage of White residents is positively associated with trip counts. Temperature remains positively significant, whereas precipitation becomes strongly negative after controlling for lagged demand and neighborhood attributes.\n\n### Model 4: Add Station Fixed Effects\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel4 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    Med_Inc.x + Percent_Taking_Transit.y + Percent_White.y +\n    as.factor(start_station),\n  data = train\n)\n\nmodel4_metrics <- tibble(\n  Metric = c(\"R-squared\", \"Adjusted R-squared\", \"Residual Std. Error\", \"N (train)\"),\n  Value = c(\n    round(summary(model4)$r.squared, 4),\n    round(summary(model4)$adj.r.squared, 4),\n    round(summary(model4)$sigma, 4),\n    nrow(train)\n  )\n)\n\nkable(model4_metrics, \n      caption = \"Model 4: Key Performance Metrics\",\n      col.names = c(\"Metric\", \"Value\")) %>%\n  kable_classic(full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n<caption>Model 4: Key Performance Metrics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> R-squared </td>\n   <td style=\"text-align:right;\"> 0.2720 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Adjusted R-squared </td>\n   <td style=\"text-align:right;\"> 0.2705 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Residual Std. Error </td>\n   <td style=\"text-align:right;\"> 1.1827 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> N (train) </td>\n   <td style=\"text-align:right;\"> 438712.0000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Model 5: Add Rush Hour Interaction\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel5 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple + Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day + rush_hour + month +\n    Med_Inc.x + Percent_Taking_Transit.y + Percent_White.y +\n    as.factor(start_station) +\n    rush_hour * weekend,  # Rush hour effects different on weekends\n  data = train\n)\n\n# Extract key metrics from Model 5\nmodel5_metrics <- tibble(\n  Metric = c(\"R-squared\", \"Adjusted R-squared\", \"Residual Std. Error\", \"N (train)\"),\n  Value = c(\n    round(summary(model5)$r.squared, 4),\n    round(summary(model5)$adj.r.squared, 4),\n    round(summary(model5)$sigma, 4),\n    nrow(train)\n  )\n)\n\nkable(model5_metrics,\n      caption = \"Model 5: Key Performance Metrics\",\n      col.names = c(\"Metric\", \"Value\")) %>%\n  kable_classic(full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>\n<caption>Model 5: Key Performance Metrics</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> R-squared </td>\n   <td style=\"text-align:right;\"> 0.2758 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Adjusted R-squared </td>\n   <td style=\"text-align:right;\"> 0.2743 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Residual Std. Error </td>\n   <td style=\"text-align:right;\"> 1.1796 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> N (train) </td>\n   <td style=\"text-align:right;\"> 438712.0000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get predictions on test set\n\n# Create day of week factor with treatment (dummy) coding\ntest <- test %>%\n  mutate(dotw_simple = factor(dotw, levels = c(\"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\")))\n\n# Set contrasts to treatment coding (dummy variables)\ncontrasts(test$dotw_simple) <- contr.treatment(7)\n\ntest$month <- factor(test$month, levels = levels(model5$model$month))\n\ntest <- test %>%\n  mutate(\n    pred1 = predict(model1, newdata = test),\n    pred2 = predict(model2, newdata = test),\n    pred3 = predict(model3, newdata = test),\n    pred4 = predict(model4, newdata = test),\n    pred5 = predict(model5, newdata = test)\n  )\n\n# Calculate MAE for each model\nmae_results <- data.frame(\n  Model = c(\n    \"1. Time + Weather\",\n    \"2. + Temporal Lags\",\n    \"3. + Demographics\",\n    \"4. + Station FE\",\n    \"5. + Rush Hour Interaction\"\n  ),\n  MAE = c(\n    mean(abs(test$Trip_Count - test$pred1), na.rm = TRUE),\n    mean(abs(test$Trip_Count - test$pred2), na.rm = TRUE),\n    mean(abs(test$Trip_Count - test$pred3), na.rm = TRUE),\n    mean(abs(test$Trip_Count - test$pred4), na.rm = TRUE),\n    mean(abs(test$Trip_Count - test$pred5), na.rm = TRUE)\n  )\n)\n\nkable(mae_results, \n      digits = 2,\n      caption = \"Mean Absolute Error by Model (Test Set)\",\n      col.names = c(\"Model\", \"MAE (trips)\")) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Mean Absolute Error by Model (Test Set)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> MAE (trips) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> 1. Time + Weather </td>\n   <td style=\"text-align:right;\"> 0.80 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2. + Temporal Lags </td>\n   <td style=\"text-align:right;\"> 0.61 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3. + Demographics </td>\n   <td style=\"text-align:right;\"> 0.86 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 4. + Station FE </td>\n   <td style=\"text-align:right;\"> 0.85 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 5. + Rush Hour Interaction </td>\n   <td style=\"text-align:right;\"> 0.80 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Model Performance Comparison (Q1 vs Q2)\n\n| Model                       | MAE (Q1 2025) | MAE (Q2 2025) |\n|-----------------------------|---------------|---------------|\n| 1\\. Time + Weather          | **0.60**      | **0.80**      |\n| 2\\. + Temporal Lags         | **0.50**      | **0.61**      |\n| 3\\. + Demographics          | 0.74          | 0.86          |\n| 4\\. + Station FE            | 0.73          | 0.85          |\n| 5\\. + Rush Hour Interaction | 0.73          | 0.80          |\n\n**Overall, prediction errors are higher in Q2 than in Q1.**\\\n\nFor example, the best model (Model 2) improves MAE from about 0.50 trips in Q1 to about 0.61 trips in Q2. All other models also show larger MAE in Q2 (e.g., Model 1 increases from 0.60 to 0.80 trips).\\\n\nThis suggests that ridership in spring–early summer is somewhat harder to predict than in winter. In Q1, demand is dominated by regular commuter patterns and strong weather effects (cold temperatures and snow suppress many trips), which makes behavior more stable. In Q2, warmer weather allows for more casual and recreational trips, as well as events and irregular travel, so there is more noise that the model cannot fully capture.\n\n**Temporal patterns also differ between Q1 and Q2.**\\\n\nIn Q1, ridership is strongly concentrated in weekday morning and evening peaks, consistent with commuter trips, and weekends are relatively quiet. In Q2, there is more activity during the middle of the day and on weekends, reflecting recreational and leisure use in warmer months. This makes demand less purely “rush-hour driven” and more spread out, which again increases prediction error.\n\n**In Q2, the most important predictors are still the temporal lag features.**\\\n\nThe coefficients on `lag1Hour`, `lag3Hours`, and `lag1day` are large and highly significant, indicating that recent station-level demand is the strongest signal of current ridership. Time-of-day (hour dummies), day-of-week, and temperature also matter, but their marginal effects become smaller once lags are included. Census variables and station fixed effects add some spatial structure, but they do not reduce MAE and in some cases slightly worsen out-of-sample performance, likely because they are associated with missing data and additional model complexity.\n\n# Part 2: Error Analysis\n\n## **2.1 Spatial patterns**\n\n### Create error maps\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_errors <- test %>%\n  filter(!is.na(pred2)) %>%\n  group_by(start_station, start_lat, start_lon) %>%\n  summarize(\n    MAE = mean(abs(Trip_Count - pred2), na.rm = TRUE),\n    avg_demand = mean(Trip_Count, na.rm = TRUE),\n    .groups = \"drop\"\n  ) %>%\n  filter(!is.na(start_lat), !is.na(start_lon))\n\n\n# Map 1 – Prediction Errors\np1_clean <- ggplot() +\n  geom_sf(data = philly_census, fill = \"grey95\", color = \"white\", size = 0.2) +\n  geom_point(\n    data = station_errors,\n    aes(x = start_lon, y = start_lat, color = MAE),\n    size = 3.0, alpha = 0.7\n  ) +\n  scale_color_viridis(\n    option = \"plasma\",\n    name = \"MAE (trips)\",\n    direction = -1\n  ) +\n  labs(\n    title = \"Prediction Errors\",\n    subtitle = \"Higher in Center City\"\n  ) +\n  mapTheme +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.subtitle = element_text(size = 10)\n  )\n\n# Map 2 – Average Demand\np2_clean <- ggplot() +\n  geom_sf(data = philly_census, fill = \"grey95\", color = \"white\", size = 0.2) +\n  geom_point(\n    data = station_errors,\n    aes(x = start_lon, y = start_lat, color = avg_demand),\n    size = 3.0, alpha = 0.7\n  ) +\n  scale_color_viridis(\n    option = \"viridis\",\n    name = \"Avg Demand (trips/hour)\",\n    direction = -1\n  ) +\n  labs(\n    title = \"Average Demand\",\n    subtitle = \"Trips per station-hour\"\n  ) +\n  mapTheme +\n  theme(\n    legend.position = \"bottom\",\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.subtitle = element_text(size = 10)\n  )\n\n# Only the maps (no legends)\np1_noleg <- p1_clean + theme(legend.position = \"none\")\np2_noleg <- p2_clean + theme(legend.position = \"none\")\n\n# Extract legends\nleg1 <- get_legend(p1_clean)\nleg2 <- get_legend(p2_clean)\n\n# Arrange clean layout\nfinal_plot <- ggarrange(\n  p1_noleg, p2_noleg,\n  ncol = 2,\n  labels = NULL\n)\n\nfinal_output <- ggarrange(\n  final_plot,\n  ggarrange(leg1, leg2, ncol = 2),\n  ncol = 1,\n  heights = c(4, 1)\n)\n\nfinal_output\n```\n\n::: {.cell-output-display}\n![](assignment5-Isabelle-Li_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nFrom the *Prediction Errors* map (Model 2), the stations with the highest MAE all cluster tightly around:\n\n### **1. Center City (highest error cluster)**\n\n-   Rittenhouse Square\n\n-   Market Street corridor\n\n-   City Hall / Suburban Station area\n\n-   University City eastern edge (34th–30th Street)\n\n### **2. University City (moderately high error)**\n\n-   Drexel / Penn campus areas\n\n-   33rd St, Lancaster Ave\n\n-   Walnut/Chestnut corridor\n\n### **3. Waterfront / Northern Liberties (moderate)**\n\n-   Penn’s Landing\n\n-   Spring Garden\n\n### **4. Areas with low error**\n\n-   Residential neighborhoods (West Philly, South Philly)\n\nHighest errors occur in Center City and eastern University City. These areas include Rittenhouse Square, Market Street, City Hall / Suburban Station, Drexel/Penn corridors, and parts of the waterfront. They share two characteristics: (1) **high demand**, and (2) **high behavioral variability**.\n\nErrors are likely driven by features missing from the model such as special events, tourism flows, campus academic schedules, and spatial spillover between nearby stations. Center City also has the strongest AM/PM peak dynamics, making it more challenging for a linear model to predict accurately.\n\nLow-demand residential neighborhoods show much lower error (\\<0.5 MAE) because ridership is stable and predictable.\n\n## **2.2 Temporal Patterns**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# MAE by time of day and day type\ntest <- test %>%\n  mutate(\n    error = Trip_Count - pred2,       \n    abs_error = abs(error),\n    time_of_day = case_when(\n      hour < 7 ~ \"Overnight\",\n      hour >= 7 & hour < 10 ~ \"AM Rush\",\n      hour >= 10 & hour < 15 ~ \"Mid-Day\",\n      hour >= 15 & hour <= 18 ~ \"PM Rush\",\n      hour > 18 ~ \"Evening\"\n    )\n  )\n\n\ntemporal_errors <- test %>%\n  group_by(time_of_day, weekend) %>%\n  summarize(\n    MAE = mean(abs_error, na.rm = TRUE),\n    .groups = \"drop\"\n  ) %>%\n  mutate(day_type = ifelse(weekend == 1, \"Weekend\", \"Weekday\"))\n\nggplot(temporal_errors, aes(x = time_of_day, y = MAE, fill = day_type)) +\n  geom_col(position = \"dodge\") +\n  scale_fill_manual(values = c(\"Weekday\" = \"#08519c\", \"Weekend\" = \"#6baed6\")) +\n  labs(\n    title = \"Prediction Errors by Time Period\",\n    subtitle = \"When is the model struggling most?\",\n    x = \"Time of Day\",\n    y = \"Mean Absolute Error (trips)\",\n    fill = \"Day Type\"\n  ) +\n  plotTheme +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](assignment5-Isabelle-Li_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nAcross the full time spectrum, prediction errors are highest during the peak commute periods, especially the **PM rush**, where demand rises sharply and fluctuates too quickly for the model to follow, leading to consistent under-prediction of the strongest spikes. The **AM rush** shows a similar pattern, though slightly milder, reflecting the model’s difficulty capturing sudden early-morning surges.\n\nMid-day errors are moderately high as well, particularly on weekends, when riding behavior is less routine and more sensitive to social activities or weather changes, making demand harder to predict. In contrast, **overnight hours** have the lowest errors because ridership is both low and stable, leaving little room for large deviations. Taken together, these patterns show that the model tends to underestimate sudden increases and slightly overestimate during gradual declines, a structural bias that appears repeatedly across hours and between weekdays and weekends.\n\n## **2.3 Demographic patterns**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Join demographic data to station errors\nstation_errors_demo <- station_errors %>%\n  left_join(\n    station_attributes %>% select(start_station, Med_Inc, Percent_Taking_Transit, Percent_White),\n    by = \"start_station\"\n  ) %>%\n  filter(!is.na(Med_Inc))\n\n# Create plots\np1 <- ggplot(station_errors_demo, aes(x = Med_Inc, y = MAE)) +\n  geom_point(alpha = 0.5, color = \"#3182bd\") +\n  geom_smooth(method = \"lm\", se = FALSE, color = \"red\") +\n  scale_x_continuous(labels = scales::dollar) +\n  labs(title = \"Errors vs. Median Income\", x = \"Median Income\", y = \"MAE\") +\n  plotTheme\n\np2 <- ggplot(station_errors_demo, aes(x = Percent_Taking_Transit, y = MAE)) +\n  geom_point(alpha = 0.5, color = \"#3182bd\") +\n  geom_smooth(method = \"lm\", se = FALSE, color = \"red\") +\n  labs(title = \"Errors vs. Transit Usage\", x = \"% Taking Transit\", y = \"MAE\") +\n  plotTheme\n\np3 <- ggplot(station_errors_demo, aes(x = Percent_White, y = MAE)) +\n  geom_point(alpha = 0.5, color = \"#3182bd\") +\n  geom_smooth(method = \"lm\", se = FALSE, color = \"red\") +\n  labs(title = \"Errors vs. Race\", x = \"% White\", y = \"MAE\") +\n  plotTheme\n\ngrid.arrange(p1, p2, p3, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](assignment5-Isabelle-Li_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nThe weak but noticeable **positive slope with median income** suggests that stations located in higher-income neighborhoods tend to have slightly larger prediction errors. These areas often have more discretionary travel, irregular trip purposes, and stronger weekend or leisure-based demand spikes that a basic temporal-lag model cannot fully capture. As a result, ridership becomes harder to forecast with simple hourly and daily patterns.\n\nIn contrast, the **negative association with transit-use share** implies that stations in neighborhoods with a high reliance on public transportation are more predictable. These communities typically have more consistent commuting routines and a tighter dependence on fixed schedules, which aligns very well with the temporal-lag structure of Model 2. When people ride transit regularly, they also tend to use bike share in more stable, repeated daily patterns, making these locations easier for the model to learn.\n\nFinally, the mild **positive relationship between errors and percent White** shows the pattern observed with income: neighborhoods that are more affluent, higher percentage of white or less transit-dependent tend to have more variable, less routine mobility behavior. These stations likely experience more irregular trip timing, spontaneous travel, and stronger seasonal fluctuations, features not fully captured by the current model.Relate errors to census characteristics\n\n# Part 3: Feature Engineering & model improvement\n\n## 3.1 Add Features\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_hall_lat <- 39.9526\ncity_hall_lon <- -75.1652\n\nholiday_dates <- as.Date(c(\n  \"2025-04-20\", \n  \"2025-04-22\", \n  \"2025-05-11\",\n  \"2025-05-26\",\n  \"2025-06-15\",\n  \"2025-06-19\"\n))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain <- train %>%\n  mutate(\n    perfect_weather = ifelse(\n      Temperature >= 60 & Temperature <= 75 & Precipitation == 0,\n      1, 0\n    ),\n    weekend_nice = weekend * perfect_weather,\n\n    dist_to_center_city = distHaversine(\n      cbind(start_lon.y, start_lat.y),\n      c(city_hall_lon, city_hall_lat)\n    ) / 1000,\n\n    holiday = ifelse(date %in% holiday_dates, 1, 0)\n  )\n\ntest <- test %>%\n  mutate(\n    perfect_weather = ifelse(\n      Temperature >= 60 & Temperature <= 75 & Precipitation == 0,\n      1, 0\n    ),\n    weekend_nice = weekend * perfect_weather,\n\n    dist_to_center_city = distHaversine(\n      cbind(start_lon.y, start_lat.y),\n      c(city_hall_lon, city_hall_lat)\n    ) / 1000,\n\n    holiday = ifelse(date %in% holiday_dates, 1, 0)\n  )\n```\n:::\n\n\n## **3.2 Implementation**\n\n### Add Features to The Best Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel6 <- lm(\n  Trip_Count ~ as.factor(hour) + dotw_simple +\n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    perfect_weather + weekend_nice +\n    dist_to_center_city + holiday,\n  data = train\n)\n\n\n# Tidy model and keep key variables\ncoef_table6 <- tidy(model6) %>%\n  filter(term %in% c(\n    \"Temperature\",\n    \"Precipitation\",\n    \"lag1Hour\",\n    \"lag3Hours\",\n    \"lag1day\",\n    \"perfect_weather\",\n    \"weekend_nice\",\n    \"dist_to_center_city\",\n    \"holiday\"\n  )) %>%\n  mutate(\n    term = recode(term,\n      \"Temperature\"          = \"Temperature (°F)\",\n      \"Precipitation\"        = \"Precipitation (in)\",\n      \"lag1Hour\"             = \"Trips 1 hour ago\",\n      \"lag3Hours\"            = \"Trips 3 hours ago\",\n      \"lag1day\"              = \"Trips 24 hours ago\",\n      \"perfect_weather\"      = \"Perfect weather (60–75°F, dry)\",\n      \"weekend_nice\"         = \"Weekend × perfect weather\",\n      \"dist_to_center_city\"  = \"Distance to Center City (km)\",\n      \"holiday\"              = \"Holiday indicator\"\n    )\n  )\n\nkable(\n  coef_table6 %>%\n    select(term, estimate, std.error, statistic, p.value),\n  digits = 3,\n  col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"p value\"),\n  caption = \"Key coefficients in Model 6 (with new engineered features)\"\n) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Key coefficients in Model 6 (with new engineered features)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Term </th>\n   <th style=\"text-align:right;\"> Estimate </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> t value </th>\n   <th style=\"text-align:right;\"> p value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Temperature (°F) </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> 25.555 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Precipitation (in) </td>\n   <td style=\"text-align:right;\"> -0.066 </td>\n   <td style=\"text-align:right;\"> 0.020 </td>\n   <td style=\"text-align:right;\"> -3.307 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Trips 1 hour ago </td>\n   <td style=\"text-align:right;\"> 0.399 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 283.079 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Trips 3 hours ago </td>\n   <td style=\"text-align:right;\"> 0.102 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 73.467 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Trips 24 hours ago </td>\n   <td style=\"text-align:right;\"> 0.119 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> 91.684 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Perfect weather (60–75°F, dry) </td>\n   <td style=\"text-align:right;\"> -0.003 </td>\n   <td style=\"text-align:right;\"> 0.004 </td>\n   <td style=\"text-align:right;\"> -0.722 </td>\n   <td style=\"text-align:right;\"> 0.470 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Weekend × perfect weather </td>\n   <td style=\"text-align:right;\"> 0.028 </td>\n   <td style=\"text-align:right;\"> 0.007 </td>\n   <td style=\"text-align:right;\"> 4.191 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Distance to Center City (km) </td>\n   <td style=\"text-align:right;\"> -0.063 </td>\n   <td style=\"text-align:right;\"> 0.001 </td>\n   <td style=\"text-align:right;\"> -74.449 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Holiday indicator </td>\n   <td style=\"text-align:right;\"> -0.013 </td>\n   <td style=\"text-align:right;\"> 0.007 </td>\n   <td style=\"text-align:right;\"> -1.932 </td>\n   <td style=\"text-align:right;\"> 0.053 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compare MAE before and after adding engineered features\n# --- Recalculate pred6 safely ---\ntest <- test %>% \n  mutate(\n    pred6 = predict(model6, newdata = test)\n  )\n\n# --- Compute baseline (model2) and new model (model6) MAE ---\nmae_before <- mean(abs(test$Trip_Count - test$pred2), na.rm = TRUE)\nmae_after  <- mean(abs(test$Trip_Count - test$pred6), na.rm = TRUE)\n\nmae_compare <- data.frame(\n  Model = c(\"Baseline Model 2 (Lags Only)\", \n            \"New Model 6 (+ Weather + Distance + Holiday)\"),\n  MAE = c(mae_before, mae_after)\n)\n\nkable(mae_compare, digits = 3,\n      caption = \"MAE Before vs. After New Features (Q2 Test Set)\")\n```\n\n::: {.cell-output-display}\n\n\nTable: MAE Before vs. After New Features (Q2 Test Set)\n\n|Model                                        |   MAE|\n|:--------------------------------------------|-----:|\n|Baseline Model 2 (Lags Only)                 | 0.611|\n|New Model 6 (+ Weather + Distance + Holiday) | 0.613|\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmae2 <- mean(abs(test$Trip_Count - test$pred2), na.rm = TRUE)\nmae6 <- mean(abs(test$Trip_Count - test$pred6), na.rm = TRUE)\n\nmae2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.6106225\n```\n\n\n:::\n\n```{.r .cell-code}\nmae6\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.613463\n```\n\n\n:::\n\n```{.r .cell-code}\nmae6 - mae2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.002840553\n```\n\n\n:::\n:::\n\n\nTo test whether additional behavioral, spatial, and contextual signals could improve prediction accuracy, I introduced three new feature groups: (1) **perfect-weather conditions** and a **weekend × nice-weather interaction**, capturing the intuition that leisure-driven demand spikes under ideal conditions; (2) **distance to Center City**, representing the strong spatial gradient in bike-share usage; and (3) **holiday indicators** for major Q2 events such as Easter, Memorial Day, and Juneteenth, which may alter mobility patterns.\n\nComparing performance before and after adding these features shows that the enhanced model (Model 6) performs almost identically to the strongest baseline model (Model 2). Model 2 achieves an MAE of **0.6106**, while Model 6 yields **0.6135**, a negligible increase of approximately **0.003 trips**. Although the engineered variables add meaningful behavioral interpretation, they do **not** improve out-of-sample predictive accuracy.\n\nThis result reflects the nature of Q2 bike-share demand: spring and early-summer ridership is already strongly explained by **temporal autocorrelation (lag features)** and **hourly/weekly seasonality**, with relatively consistent warm weather and limited extremes. Because these patterns dominate usage, additional features offer little incremental predictive power and instead introduce slight overfitting.\n\n## **3.3 Poisson Model**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel6_pois <- glm(\n  Trip_Count ~ as.factor(hour) + dotw_simple +\n    Temperature + Precipitation +\n    lag1Hour + lag3Hours + lag1day +\n    perfect_weather + weekend_nice +\n    dist_to_center_city + holiday,\n  data = train,\n  family = poisson(link = \"log\")\n)\n\npoisson_summary <- data.frame(\n  Metric = c(\n    \"Null deviance\",\n    \"Residual deviance\",\n    \"AIC\"\n  ),\n  Value = c(\n    round(model6_pois$null.deviance, 2),\n    round(model6_pois$deviance, 2),\n    round(model6_pois$aic, 2)\n  )\n)\n\nkable(poisson_summary,\n      caption = \"Poisson Regression Model Summary (Key Metrics)\",\n      col.names = c(\"Metric\", \"Value\")) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Poisson Regression Model Summary (Key Metrics)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Null deviance </td>\n   <td style=\"text-align:right;\"> 701096.0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Residual deviance </td>\n   <td style=\"text-align:right;\"> 441087.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AIC </td>\n   <td style=\"text-align:right;\"> 774319.7 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest <- test %>% \n  mutate(\n    pred6_pois = predict(model6_pois, newdata = test, type = \"response\")\n  )\n\nmae_pois <- mean(abs(test$Trip_Count - test$pred6_pois), na.rm = TRUE)\nmae_pois\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.639133\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmae_lin <- mean(abs(test$Trip_Count - test$pred6), na.rm = TRUE)\n\ndata.frame(\n  Model = c(\"Linear Model 6\", \"Poisson Model 6\"),\n  MAE = c(mae_lin, mae_pois)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            Model      MAE\n1  Linear Model 6 0.613463\n2 Poisson Model 6 0.639133\n```\n\n\n:::\n:::\n\n\nAlthough trip counts are discrete and non-negative, making Poisson regression a natural candidate, the Poisson specification did not outperform the linear model in this case. The Poisson model substantially reduced the null deviance (from about 701,096 to 441,087), which indicates that it captures important structure in the data. However, when evaluated out-of-sample on the Q2 test set, its MAE is **0.639**, which is noticeably worse than the MAE of the linear Model 6 (**0.613**).\n\n# Part 4: Critical Reflection\n\n## **4.1 Operational implications**\n\nWith a final test-set MAE of roughly **0.61 trips per station-hour**, the model is accurate enough to provide meaningful operational support for Indego, especially for routine rebalancing during normal weekdays. Most stations average between 0–2 trips per hour in Q2, so an average error of 0.6 represents a relatively small deviation from true demand. In other words, the model reliably captures broad temporal patterns: commuting peaks, weather-driven changes, and weekend shifts, which are the operational factors that matter most for daily fleet management. However, from the error analysis, the system performs less consistently in areas with highly irregular or discretionary travel (Center City, university areas, tourist clusters). These are precisely the locations where under-prediction or over-prediction can create rebalancing problems: late-morning surges, sudden evening spikes, or unusually warm weekends can leave docks empty or bikes stranded unless staff intervene manually.\n\nGiven this, the model can be **deployed operationally**, but with clear conditions. It should be used as a *decision-support tool*, not an autonomous system. The predictions can guide baseline redistribution plans, flag high-risk hours, and help prioritize which stations need closer monitoring. But stations with historically volatile demand and days with atypical weather, holidays, or major events will still require human oversight or real-time adjustments.\n\n## **4.2 Equity considerations**\n\nThe error patterns suggest that prediction accuracy is not evenly distributed across Philadelphia. Stations located in higher-income, majority-White neighborhoods particularly those with more discretionary and irregular travel. This show larger residuals, while stations in transit-dependent, lower-income communities tend to be more predictable. This raises an important equity concern: the model performs best in neighborhoods where travel patterns are already stable and predictable, and worst in areas where riders may rely on Indego as a flexible or secondary mobility option.\n\nIf such a system were deployed without safeguards, it could unintentionally reinforce existing disparities. Under-predicting demand in transit-reliant communities could mean empty docks, reduced availability, and longer wait times directly undermining mobility for riders with fewer alternatives.\n\nTo mitigate these risks, several safeguards should be implemented:\\\n\n1.  **Equity-weighted rebalancing rules** ensuring underserved neighborhoods receive a minimum guaranteed baseline of bike availability regardless of predicted demand\\\n\n2.  **Error monitoring** that track model performance separately by neighborhood demographics\\\n\n3.  **Human-in-the-loop overrides** where planners can adjust allocations in census tracts showing sustained high error\\\n\n4.  **Periodic model retraining** with explicit fairness constraints or stratified sampling to ensure equitable performance across different community types\n\n## **4.3 Model limitations**\n\nDespite incorporating temporal lags, weather, spatial context, and holiday effects, the model still misses several important behavioral patterns. Bicycle demand is heavily influenced by **micro-events** such as neighborhood festivals, block parties, school schedules, university calendars, and special events at venues like the stadium district—none of which are captured in the current dataset. The model also assumes that relationships between predictors and demand are **smooth and stable over time**, but real bike-share patterns often shift abruptly due to construction, temporary station closures, seasonal promotions, or sudden weather changes that are not recorded by hourly temperature and precipitation alone. Moreover, riders make spontaneous decisions in response to perceived safety, traffic conditions, and trip chaining with transit—complex behaviors that cannot be explained using simple linear terms.\n\nIf given more time and richer data, the predictive system could be significantly improved by incorporating features that better capture the behavioral, spatial, and contextual complexity of bike-share demand. The current model relies primarily on temporal lags, weather, and basic spatial structure, which limits its ability to account for major demand drivers such as large events, university schedules, tourism flow, or transit disruptions. With access to real event data (concerts, stadium schedules, conventions, sports games), SEPTA operational data, academic calendars for Penn/Drexel/Temple, and park/office/restaurant POI densities, the model would be able to reflect more realistic fluctuations in ridership patterns. These variables are known to heavily shape Philadelphia’s mobility rhythms but are not represented in the present dataset.\n\nMethodologically, the model could be strengthened by moving beyond linear regression into more flexible forms to capture non-linear relationships and temporal dependencies that the current model cannot express. Expanding the training window to multiple years rather than a single quarter would also allow the model to learn seasonal differences, long-term trends, and year-over-year behavioral changes. With richer data and more advanced modeling frameworks, Indego could move from hour-ahead prediction toward more robust real-time forecasting and dynamic rebalancing systems.\n",
    "supporting": [
      "assignment5-Isabelle-Li_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}